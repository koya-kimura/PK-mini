# p5js-sushi-sequencer

p5js-sushi-sequencerは、Akai APC Mini MK2をステップシーケンサーとして活用し、p5.js + TypeScriptで生成されるビジュアルと連携させるVJ/ライブコーディング向けツールです。制作（パターン構築）とプレイ（ライブパフォーマンス）の両方を意識して設計されており、MIDIコントローラー操作とキーボード操作を組み合わせて、複数シーンの切り替えやUIオーバーレイの表示を行います。

## 主な特徴
- **8×8ステップシーケンサー**：APC Mini MK2のパッドを使って8パターン×8ステップのループを構築。
- **多層シーン合成**：晴天・波・雲などのモーションや寿司タイポグラフィなど、複数の描画モジュールを同時にレンダリング。
- **リアルタイムUIオーバーレイ**：HUD・グリッド・カメラフレーム風など複数のUIを切り替えて表示。
- **ポストエフェクト制御**：フェーダーでノイズ、モザイク、RGB分離、モノクロ化など8種のシェーダーパラメーターをリアルタイム制御。
- **TypeScript + Vite構成**：モダンな開発環境とホットリロードによる高速な制作フロー。

## 必要環境
- Node.js（推奨:18以上）
- npm
- Web MIDI API対応ブラウザ（Google Chrome推奨）
- Akai APC Mini MK2（または互換のWeb MIDIデバイス）

## セットアップ
```bash
npm install
```

## 開発サーバーの起動
```bash
npm run dev
```

1. コマンド実行後、Viteが`http://localhost:5173`を立ち上げます。
2. ブラウザ（Chrome推奨）でアクセスし、ページ上部のMIDI利用許可ダイアログが表示された場合は「許可」を選びます。
3. APC Mini MK2をUSB接続し、LEDが点灯すれば準備完了です。

## ビルド&プレビュー
```bash
npm run build
npm run preview
```

`npm run build`はTypeScriptコンパイルとViteビルドを実行し、`dist/`配下に配布用ファイルが生成されます。`npm run preview`を使うとビルド成果物をローカルで確認できます。

## MIDI接続のポイント
- APC Mini MK2以外のデバイスを使用する場合でも、Web MIDI APIで認識されるデバイスであれば利用できます。
- 接続がうまくいかない場合は、
	- ブラウザがHTTPSもしくは`localhost`で動いているか
	- Chromeの`chrome://flags/#midi-manager-dynamic`が既定値になっているか
	- OS側で他ソフトがMIDIを占有していないか
	を確認してください。
- デバイス未接続の場合は、LEDフィードバックが無効になり、フェーダー値は既定値（0）になります。

## 制作フロー（Pattern Production）
1. **パターン選択**：サイドボタン（赤い行）で8パターンを切り替えます。選択中のボタンは点灯します。
2. **ステップ入力**：8×8のグリッドパッドで各カラムの発火行を選択。1カラムにつき1行が記録されます。
3. **シーケンス再生**：BPM Managerが進行するビートに合わせて、選択したパターンのステップが順次評価され、各シーンへ値が送られます。
4. **パターン消去**：フェーダー9（右端）を最大まで上げると、その瞬間のパターンがクリアされます。
5. **テンポ調整**：キーボード`Enter`でタップテンポ。BPMはビート更新タイミングで反映されます。

制作中はとくに`UI: Grid Overview`を表示しておくと、現在のカラムや予定ステップが視覚的に確認できます。

## プレイフロー（Live Performance）
1. **シーン合成**：以下のモーションが同時に描画され、シーケンサーの値で強調されます。
	 - SunnyMotion（サンバースト）
	 - WaveMotion（波紋）
	 - CloudMotion（雲帯）
	 - UmbrellaMotion（傘パターン）
	 - SushiMotion（回転寿司トラック）
	 - ThunderMotion（稲妻）
	 - SushiTypographyMotion（SUSHIタイポ）
	 - FlowTypographyMotion（sushi/p5jsタイポ）
2. **ポストエフェクト**：APC Mini MK2の9本のフェーダーで下表のエフェクトを操作できます。

| フェーダー | シェーダーUniform | 効果 | 0 の状態 | 1 の状態 |
|-----------|---------------------|------|----------|----------|
| 1 | `u_invert` | 反転 | 通常色 | 完全反転 |
| 2 | `u_mosaic` | モザイク | 非適用 | 大粒モザイク |
| 3 | `u_noise` | ノイズ揺らぎ | 静止 | 最大ノイズ |
| 4 | `u_tile` | タイル分割 | 通常 | 4×4タイル化 |
| 5 | `u_rgbSplit` | RGB分離 | 通常合成 | 強い色ズレ |
| 6 | `u_zoom` | 中心ズーム | 1× | 2.5×ズーム |
| 7 | `u_blockRotate` | 16×9ブロック回転 | 不動 | 90°回転 |
| 8 | `u_monochrome` | ポスタライズ白黒 | フルカラー | 3階調モノクロ |

フェーダー9（右端）はポストエフェクトに割り当てず、最大まで上げた瞬間に選択中のパターンを即時クリアします。

3. **UI切り替え**：状況に応じて情報量を変えられるよう、キーボードでUIを瞬時に変更できます（詳しくは下記「操作リファレンス」）。
4. **全画面表示**：スペースキーでフルスクリーン化し、VJ出力に備えます。

## 操作リファレンス
### キーボード
- `Space`：ブラウザキャンバスをフルスクリーンにする
- `Enter`：タップテンポ
- `0`：UI非表示（`UI_None`）
- `1`：`UI: Status Overlay`（中央に大きな“SUSHI”）
- `2`：`UI: Grid Overview`（8×8シーケンスの可視化）
- `3`：`UI: Camera Frame`（カメラファインダー風のHUD）
- `4`：`UI: sushi x p5js`（タイトルロゴ表示）

### APC Mini MK2
- **グリッド（8×8パッド）**：各ステップの行を選択。
- **サイドボタン（右端縦列）**：使用中のパターンを選択。
- **フェーダー1〜8**：上表のポストエフェクトを制御。
- **フェーダー9（右端）を最大まで上げる**：選択中パターンの即時クリア。
- **フェーダーボタン**：オン中は約10%の確率でフェーダー値が0↔1にランダム遷移し、パルス的な演出を加える。

## シーン/UIを追加するには

### 新しいシーンを追加する
1. `src/scene/`に新しいモーションファイル（クラス）を作成します。`update(tex, sequenceValue, beat)`を実装し、`p5.Graphics`に描画するようにします。
2. `SceneManager`のコンストラクターでインスタンス化し、`update()`内で既存シーンと同様に`this.<Scene>.update(...)`を呼び出して統合します。
3. 必要に応じて`ColorPalette`に色定義を追加します。

### 新しいUIオーバーレイを追加する
1. `src/ui/`に`IUIOverlay`を実装したクラスを作成します。`draw(p, tex, midi, bpmManager, context)`内でUIを描画してください。
2. `SceneManager`の`uiManager.setup`にエントリを追加し、任意のキーバインド（`main.ts`内`keyPressed`）を割り当てます。
3. UI切り替え時に必要な初期化処理があれば`UIManager`側で調整します。

## プロジェクト構成
```
src/
	main.ts               # p5エントリーポイント
	scene/                # 各ビジュアルモーション
	ui/                   # UIオーバーレイクラス
	midi/                 # MIDIデバイス操作とシーケンサー
	rhythm/               # BPM管理
	utils/                # カラーパレット、Easingなどのユーティリティ
public/
	shader/post.vert|frag # ポストプロセス用シェーダー
```

## トラブルシューティング
- **MIDIデバイスが認識されない**：ブラウザのコンソールに`MIDI device not found`が表示されます。USBケーブル、ブラウザの権限、他アプリの占有などを確認してください。
- **描画が真っ黒になる**：WebGLやシェーダー設定が初期化されていない可能性があります。ブラウザをリロード、または`npm run dev`を再起動してください。
- **モノクロから戻らない**：フェーダー8（`u_monochrome`）が0になっているか確認し、フェーダーボタンをOFFにしてください。